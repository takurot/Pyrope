syntax = "proto3";

package pyrope.policy;


message ClusterAccess {
  int64 timestamp = 1;
  int32 cluster_id = 2;
}

message ReportClusterAccessRequest {
    string tenant_id = 1;
    string index_name = 2;
    repeated ClusterAccess accesses = 3;
}

message ReportClusterAccessResponse {
    string status = 1;
}

message GetPrefetchRulesRequest {
    string tenant_id = 1;
    string index_name = 2;
}

message PrefetchRule {
    int32 current_cluster_id = 1;
    int32 next_cluster_id = 2;
}

message GetPrefetchRulesResponse {
    repeated PrefetchRule rules = 1;
}

service PolicyService {
  rpc GetIndexPolicy (IndexPolicyRequest) returns (IndexPolicyResponse);
  rpc ReportSystemMetrics (SystemMetricsRequest) returns (SystemMetricsResponse);
  
  // Predictive Prefetching
  rpc ReportClusterAccess (ReportClusterAccessRequest) returns (ReportClusterAccessResponse);
  rpc GetPrefetchRules (GetPrefetchRulesRequest) returns (GetPrefetchRulesResponse);
}


message IndexPolicyRequest {
  string tenant_id = 1;
  string index_name = 2;
  // Optional sample data to help choose parameters
  // bytes sample_vectors = 3; 
}

message IndexPolicyResponse {
  int32 pq_m = 1;
  int32 pq_construction = 2;
  int32 pca_dimension = 3;
  string status = 4;
}

message SystemMetricsRequest {
  double qps = 1;
  double miss_rate = 2;
  double latency_p99_ms = 3;
  double cpu_utilization = 4;
  double gpu_utilization = 5;
  int64 cache_hit_total = 6;
  int64 cache_miss_total = 7;
  int64 timestamp_unix_ms = 8;
}

message SystemMetricsResponse {
  string status = 1;
  int32 next_report_interval_ms = 2;
  WarmPathPolicy policy = 3;
}

message WarmPathPolicy {
  double admission_threshold = 1;
  int32 ttl_seconds = 2;
  int32 eviction_priority = 3;
}
