syntax = "proto3";

package pyrope.policy;


message ClusterAccess {
  int64 timestamp = 1;
  int32 cluster_id = 2;
}

message ReportClusterAccessRequest {
    string tenant_id = 1;
    string index_name = 2;
    repeated ClusterAccess accesses = 3;
}

message ReportClusterAccessResponse {
    string status = 1;
}

message GetPrefetchRulesRequest {
    string tenant_id = 1;
    string index_name = 2;
}

message PrefetchRule {
    int32 current_cluster_id = 1;
    int32 next_cluster_id = 2;
}

message GetPrefetchRulesResponse {
    repeated PrefetchRule rules = 1;
}

service PolicyService {
  rpc GetIndexPolicy (IndexPolicyRequest) returns (IndexPolicyResponse);
  rpc ReportSystemMetrics (SystemMetricsRequest) returns (SystemMetricsResponse);
  
  // Predictive Prefetching
  rpc ReportClusterAccess (ReportClusterAccessRequest) returns (ReportClusterAccessResponse);
  rpc GetPrefetchRules (GetPrefetchRulesRequest) returns (GetPrefetchRulesResponse);

  // AI Model Management (P8-4)
  rpc ListModels (Empty) returns (ModelList);
  rpc TrainModel (TrainRequest) returns (TrainResponse);
  rpc DeployModel (DeployRequest) returns (DeployResponse);
  rpc RollbackModel (RollbackRequest) returns (RollbackResponse);
  rpc GetEvaluations (Empty) returns (EvaluationMetrics);
}


message IndexPolicyRequest {
  string tenant_id = 1;
  string index_name = 2;
  // Optional sample data to help choose parameters
  // bytes sample_vectors = 3; 
}

message IndexPolicyResponse {
  int32 pq_m = 1;
  int32 pq_construction = 2;
  int32 pca_dimension = 3;
  string status = 4;
}

message SystemMetricsRequest {
  double qps = 1;
  double miss_rate = 2;
  double latency_p99_ms = 3;
  double cpu_utilization = 4;
  double gpu_utilization = 5;
  int64 cache_hit_total = 6;
  int64 cache_miss_total = 7;
  int64 timestamp_unix_ms = 8;
}

message SystemMetricsResponse {
  string status = 1;
  int32 next_report_interval_ms = 2;
  WarmPathPolicy policy = 3;
}

message WarmPathPolicy {
  double admission_threshold = 1;
  int32 ttl_seconds = 2;
  int32 eviction_priority = 3;
}

// AI Model Management Messages
message Empty {}

message ModelInfo {
  string version = 1;
  string created_at = 2;
  string status = 3; // "trained", "active", "canary"
  double evaluation_score = 4;
}

message ModelList {
  repeated ModelInfo models = 1;
  string active_model_version = 2;
  string canary_model_version = 3;
}

message TrainRequest {
  string dataset_path = 1; // Optional override
}

message TrainResponse {
  string status = 1;
  string job_id = 2;
}

message DeployRequest {
  string version = 1;
  bool canary = 2;
  repeated string canary_tenants = 3; // Tenants to route to canary model
}

message DeployResponse {
  string status = 1;
  string version = 2;
}

message RollbackRequest {
    bool canary_only = 1;
}

message RollbackResponse {
    string status = 1;
    string active_version = 2;
}

message EvaluationMetrics {
    double current_p99_improvement = 1;
    double current_cache_hit_rate = 2;
    map<string, double> other_metrics = 3;
}
